apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: stellar
spec:
  replicas: 1
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: "100%"
      maxSurge: "100%"
  template:
    metadata:
      labels:
        app: stellar
    spec:
      containers:
        - name: cloudsql-proxy
          image: gcr.io/cloudsql-docker/gce-proxy:1.09
          command: ["/cloud_sql_proxy", "--dir=/cloudsql",
                    "-instances={{database_instance}}",
                    "-credential_file=/secrets/cloudsql/credentials.json"]
          volumeMounts:
            - name: cloudsql-instance-credentials
              mountPath: /secrets/cloudsql
              readOnly: true
            - name: ssl-certs
              mountPath: /etc/ssl/certs
            - name: cloudsql
              mountPath: /cloudsql
        - name: stellar-core
          image: "{{stellar_core_image}}"
          ports:
          - name: core-http
            containerPort: 11625
          - name: core-peer
            containerPort: 11626
          volumeMounts:
          - name: stellar-core-cfg
            mountPath: /configs
          - name: core-data
            mountPath: /data
          env:
            - name: NONEWHIST
              value: "1"
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: stellar-database-credentials
                  key: STELLAR_CORE_DATABASE_URL

        - name: stellar-horizon
          image: "{{stellar_horizon_image}}"
          command:
            - "sh"
            - "-c"
            - "horizon db init; horizon --port 8001 --db-url=$(DATABASE_URL) --stellar-core-db-url=$(STELLAR_CORE_DATABASE_URL) --ingest=true --stellar-core-url=http://127.0.0.1:11626"
          ports:
          - name: horizon-http
            containerPort: 8001
          env:
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: stellar-database-credentials
                  key: STELLAR_HORIZON_DATABASE_URL
            - name: STELLAR_CORE_DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: stellar-database-credentials
                  key: STELLAR_CORE_DATABASE_URL
            - name: INGEST
              value: "true"

        - name: stellar-horizon-proxy
          image: nginx
          volumeMounts:
            - name: stellar-horizon-proxy-data
              mountPath: /certs
              readOnly: true
          ports:
          - name: horizon-https
            containerPort: 443
          env:
           - name: HOST
             value: _
           - name: PORT
             value: "443"
           - name: BACKEND_URL
             value: http://127.0.0.1:8001
           - name: SSL_CERT_PATH
             value: "/certs/{{stellar_horizon_ssl_crt_filename}}"
           - name: SSL_CERT_KEY_PATH
             value: "/certs/{{stellar_horizon_ssl_key_filename}}"
          command:
            - "/bin/bash"
            - "-c"
            - "envsubst '$''HOST $''PORT $''BACKEND_URL $''SSL_CERT_PATH $''SSL_CERT_KEY_PATH' < /certs/https-proxy.template > /etc/nginx/conf.d/default.conf && nginx -g 'daemon off;'"

        - name: geth
          image: ethereum/client-go
          command:
            - geth
            - --rpc
            - --rpcaddr=0.0.0.0
            - --rpccorsdomain=*
            - --rpcapi=net,eth
            - --testnet
            - --cache=2048
            - --light
            - --datadir=/data
          env:
            - name: PATH
              value: "$PATH:/usr/local/bin/"
          ports:
          - name: geth-rpc
            containerPort: 8545
          - name: geth-peers
            containerPort: 3030
          volumeMounts:
          - name: geth-data
            mountPath: /data

        - name: stellar-bifrost
          image: "{{stellar_bifrost_image}}"
          command: ["sh", "-c", "/entry.sh init; /entry.sh server"]
          env:
          - name: BIFROST_CFG
            valueFrom:
              secretKeyRef:
                name: stellar-bifrost-credentials
                key: STELLAR_BIFROST_CFG
          - name: BIFROST_ETHEREUM_RPC_SERVER
            value: "127.0.0.1:8545"
          - name: BIFROST_STELLAR_HORIZON
            value: "http://127.0.0.1:8001"
          - name: BIFROST_DB_DSN
            valueFrom:
              secretKeyRef:
                name: stellar-bifrost-credentials
                key: STELLAR_BIFROST_DATABASE_URL
          ports:
          - name: bifrost-http
            containerPort: 8000

        - name: web-app
          image: "{{stellar_bifrost_client_image}}"
          ports:
          - name: web-app-http
            containerPort: 3000
          env:
            - name: HORIZON_URL
              value: "https://{{load_balancer_ip}}:$(STELLAR_SERVICE_PORT_HORIZON_HTTPS)"
            - name: BIFROST_URL
              value: "http://{{load_balancer_ip}}:$(STELLAR_SERVICE_PORT_BIFROST_HTTP)"
            - name: ISSUING_ACCOUNT
              value: GD5H2WSHTWVTZI5BR3V5XTRBCFDMEOKFMXR4Y4PU337K7WS55UAADI5T
            - name: NODE_ENV
              value: development

      volumes:
        - name: cloudsql-instance-credentials
          secret:
            secretName: cloudsql-instance-credentials
        - name: stellar-core-cfg
          secret:
            secretName: stellar-core-cfg
        - name: ssl-certs
          hostPath:
            path: /etc/ssl/certs
        - name: cloudsql
          emptyDir:
        - name: geth-data
          gcePersistentDisk:
            pdName: "{{geth_data_disk}}"
            fsType: ext4
        - name: core-data
          gcePersistentDisk:
            pdName: "{{stellar_core_data_disk}}"
            fsType: ext4
        - name: stellar-horizon-proxy-data
          secret:
            secretName: stellar-horizon-proxy-secret
